name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]

jobs:
  # Test and Build Job
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint
        run: npm run lint

      - name: Run Prettier check
        run: npm run format:check

      - name: Build application
        run: npm run build

      # API —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î DATABASE_URL
      - name: Test API endpoints (if database available)
        run: |
          if [ -n "$DATABASE_URL" ]; then
            echo "Testing API with database..."
            npm run dev &
            sleep 10
            curl -f http://localhost:3000/api/health || exit 1
            kill %1
          else
            echo "Skipping API tests - no database configured"
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # Deploy to Development
  deploy-development:
    name: Deploy to Development
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build for development
        run: npm run build:dev

      - name: Deploy notification (Development)
        run: |
          echo "üöÇ Railway –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç (develop) –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
          echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Railway dashboard –¥–ª—è develop —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞"

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build for staging
        run: npm run build:staging

      - name: Deploy notification (Staging)
        run: |
          echo "üöÇ Railway –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç (staging) –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
          echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Railway dashboard –¥–ª—è staging —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞"

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build for production
        run: npm run build:prod

      - name: Deploy notification
        run: |
          echo "üöÇ Railway –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ GitHub integration"
          echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Railway dashboard: https://railway.com/project/a9cd4ed0-fce4-44bc-be43-71f2fe8d52ed"
          echo "‚úÖ Build —É—Å–ø—ñ—à–Ω–∏–π - Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–µ–ø–ª–æ—ó—Ç—å –∑–º—ñ–Ω–∏"
