# –ù–∞–∑–≤–∞ workflow, —è–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ GitHub Actions UI
name: CI/CD Pipeline

# –¢—Ä–∏–≥–µ—Ä–∏ - –∫–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è workflow
on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ push (–∫–æ–º—ñ—Ç) –Ω–∞ –∑–∞–∑–Ω–∞—á–µ–Ω—ñ –≥—ñ–ª–∫–∏
  push:
    branches: [main, develop, staging]
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ Pull Request –Ω–∞ –∑–∞–∑–Ω–∞—á–µ–Ω—ñ –≥—ñ–ª–∫–∏
  pull_request:
    branches: [main, develop, staging]

# –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö job'—ñ–≤ —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ —Ü—å–æ–º—É workflow
jobs:
  # Test and Build Job - –æ—Å–Ω–æ–≤–Ω–∏–π job –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–±—ñ—Ä–∫–∏
  test-and-build:
    # –ß–∏—Ç–∞–±–µ–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ job'—É –¥–ª—è UI
    name: Test and Build
    # –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞ –Ω–∞ —è–∫—ñ–π –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è job (Ubuntu Linux –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó)
    runs-on: ubuntu-latest

    # –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∫—Ä–æ–∫—ñ–≤ —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ —Ü—å–æ–º—É job
    steps:
      # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é –Ω–∞ runner
      - name: Checkout code
        uses: actions/checkout@v4  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≥–æ—Ç–æ–≤—É action –≤—ñ–¥ GitHub

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î Node.js –Ω–∞ runner
      - name: Setup Node.js
        uses: actions/setup-node@v4  # –ì–æ—Ç–æ–≤–∞ action –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Node.js
        with:
          node-version: '22'  # –í–µ—Ä—Å—ñ—è Node.js (–ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–ª—è Nuxt 4)

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î npm –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ø—Ä–æ–µ–∫—Ç—É
      - name: Install dependencies
        run: npm install  # –í–∏–∫–æ–Ω—É—î –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ runner'–∞

      # –ü–µ—Ä–µ–≤—ñ—Ä—è—î —è–∫—ñ—Å—Ç—å –∫–æ–¥—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é ESLint
      - name: Run ESLint
        run: npm run lint  # –ó–∞–ø—É—Å–∫–∞—î —Å–∫—Ä–∏–ø—Ç –∑ package.json

      # –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∫–æ–¥—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Prettier
      - name: Run Prettier check
        run: npm run format:check  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –∫–æ–¥ –≤—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ

      # –ó–±–∏—Ä–∞—î –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è production
      - name: Build application
        run: npm run build  # –°—Ç–≤–æ—Ä—é—î optimized build –ø—Ä–æ–µ–∫—Ç—É

  # Deploy to Development - –¥–µ–ø–ª–æ–π –Ω–∞ development —Å–µ—Ä–≤–µ—Ä
  deploy-development:
    # –ß–∏—Ç–∞–±–µ–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ –¥–ª—è UI
    name: Deploy to Development
    # –ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å - —Ü–µ–π job –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ test-and-build
    needs: test-and-build
    # –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
    runs-on: ubuntu-latest
    # –£–º–æ–≤–∞ –∑–∞–ø—É—Å–∫—É - —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ push –Ω–∞ –≥—ñ–ª–∫—É develop (–Ω–µ –Ω–∞ PR)
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      - name: Checkout code
        uses: actions/checkout@v4

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î Node.js (—Ç–æ–π —Å–∞–º–∏–π —â–æ —ñ –≤ test job)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (–∑–Ω–æ–≤—É, –±–æ —Ü–µ –Ω–æ–≤–∏–π runner)
      - name: Install dependencies
        run: npm install

      # –ó–±–∏—Ä–∞—î –¥–æ–¥–∞—Ç–æ–∫ –∑ development –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
      - name: Build for development
        run: npm run build:dev  # NODE_ENV=development

      # –í–∏–∫–æ–Ω—É—î –¥–µ–ø–ª–æ–π –Ω–∞ development —Å–µ—Ä–≤–µ—Ä
      - name: Deploy to development
        run: |
          echo "üöÄ Deploying to development environment"
          echo "Branch: ${{ github.ref }}"        # –ü–æ–∫–∞–∑—É—î –ø–æ—Ç–æ—á–Ω—É –≥—ñ–ª–∫—É
          echo "Commit: ${{ github.sha }}"        # –ü–æ–∫–∞–∑—É—î SHA –∫–æ–º—ñ—Ç—É
          # –¢—É—Ç –±—É–¥–µ –∫–æ–º–∞–Ω–¥–∞ –¥–µ–ø–ª–æ—é: rsync, scp, docker push, kubectl apply —Ç–æ—â–æ

  # Deploy to Staging - –¥–µ–ø–ª–æ–π –Ω–∞ staging (—Ç–µ—Å—Ç–æ–≤–µ) —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
  deploy-staging:
    # –ß–∏—Ç–∞–±–µ–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ –¥–ª—è UI
    name: Deploy to Staging
    # –ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å - –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ test-and-build
    needs: test-and-build
    # –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞ Ubuntu
    runs-on: ubuntu-latest
    # –£–º–æ–≤–∞ - —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ push –Ω–∞ staging –≥—ñ–ª–∫—É (–Ω–µ PR)
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'

    steps:
      # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞–ª–∞—à—Ç–æ–≤—É—î Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –ø–∞–∫–µ—Ç–∏
      - name: Install dependencies
        run: npm install

      # –ó–±–∏—Ä–∞—î –∑ staging –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é
      - name: Build for staging
        run: npm run build:staging  # NODE_ENV=staging

      # –î–µ–ø–ª–æ—ó—Ç—å –Ω–∞ staging —Å–µ—Ä–≤–µ—Ä (—Ñ—ñ–Ω–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ production)
      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment"
          echo "Branch: ${{ github.ref }}"        # refs/heads/staging
          echo "Commit: ${{ github.sha }}"        # SHA –∫–æ–º—ñ—Ç—É
          # –¢—É—Ç –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –¥–µ–ø–ª–æ—é –Ω–∞ staging: docker, k8s, ssh —Ç–æ—â–æ

  # Deploy to Production - –¥–µ–ø–ª–æ–π –Ω–∞ production (–∂–∏–≤–∏–π) —Å–µ—Ä–≤–µ—Ä
  deploy-production:
    # –ù–∞–∑–≤–∞ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
    name: Deploy to Production
    # –ß–µ–∫–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç–µ—Å—Ç—ñ–≤
    needs: test-and-build
    # Ubuntu —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    # –¢—ñ–ª—å–∫–∏ –ø—Ä–∏ push –Ω–∞ main (–ø—Ä–æ–¥–∞–∫—à–Ω –≥—ñ–ª–∫–∞)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      # –û—Ç—Ä–∏–º—É—î –æ—Å—Ç–∞–Ω–Ω—ñ–π –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î Node.js 22
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # –°—Ç–∞–±—ñ–ª—å–Ω–∞ LTS –≤–µ—Ä—Å—ñ—è

      # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
      - name: Install dependencies
        run: npm install

      # –ó–±–∏—Ä–∞—î optimized production build
      - name: Build for production
        run: npm run build:prod  # NODE_ENV=production, minification, optimization

      # –î–µ–ø–ª–æ—ó—Ç—å –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–∏ (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ)
      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production environment"
          echo "Branch: ${{ github.ref }}"        # refs/heads/main
          echo "Commit: ${{ github.sha }}"        # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–æ–º—ñ—Ç—É
          # –¢—É—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤—ñ –∫–æ–º–∞–Ω–¥–∏ –¥–µ–ø–ª–æ—é –Ω–∞ production
